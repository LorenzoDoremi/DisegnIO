<!DOCTYPE html>

<head>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.4.2/lib/p5.js"></script>
    <script src="socket.js"></script>
    <style>
        * {
            padding: 0;
            margin: 0;
            overflow: hidden;
            font-family: "arial";
        }

        #clear_button {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            background: red;
            color: white;
            z-index: 10;
            cursor: pointer;
        }

        h1 {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 10;
            color: white;
        }

        #coords {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 10;
            color: white;
        }

        #snakio {
            width: 100%;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: black;
        }
    </style>
</head>

<body>
    <h1> Snak.IO</h1>
    <script>
        var socket = io();
        // mi connetto
       socket.emit("conn", "hello!")
       
       var points = [];
       socket.on("point", (new_p) => {
             points.push(new_p)
       })
        var x = 1376;
        var y = 768;
        var clear_Canvas = false;


        var my_color = [parseInt(Math.random() * 255), parseInt(Math.random() * 255), parseInt(Math.random() * 255)]

        var head = { x: 100, y: 100 };
        var snake_size = 15;
        var snake = [head, { x: head.x - snake_size, y: 100 }, { x: head.x - 2 * snake_size, y: 100 }, { x: head.x - 2 * snake_size, y: 100 }];
        var xtr = 0;
        var ytr = 0;
        
        var last_dir = 0;
        var dir = 1;
        function setup() {
            noStroke();
            createCanvas(x, y).parent("#snakio");
            drawBackground();




        }
        function drawBackground() {

            strokeWeight(1);
            background(0);
            stroke(30);
            frameRate(20);
            //  rectMode(CENTER);
            for (var i = 0; i < 1376/snake_size; i++) {
                line(i * snake_size, 0, i * snake_size, y);
                line(0, i * snake_size, x, i * snake_size);
            }


        }
        function draw() {
            drawBackground();
            move_snake();
            
            points.forEach((point, index) => {

                if(dist(snake.at(-1).x, snake.at(-1).y, point.x, point.y) < snake_size) {
                  
                   points.splice(index, 1);
                   grow_snake();
                   grow_snake();
                   socket.emit("eat", snake.at(-1));
                   
                }
                else {
                fill(255,0,0);
                rect(point.x, point.y, snake_size)
                }

            })
            fill(my_color);

            // mi mangio da solo            
            snake.forEach((p,index) => {

                if( index < snake.length -1 && snake.at(-1).x == p.x && snake.at(-1).y == p.y) {
                    snake.splice(0, index);
                }
                rect(p.x, p.y, snake_size);


            })

            document.getElementById("coords").innerHTML = "PUNTEGGIO: "+snake.length +" \n last_dir = "+last_dir+ "\n dir = "+dir;

            
            
            // invio al server la mia posizione della testa
            
           


        }
        
        function grow_snake() {
            if(dir == 1) {
                
                snake.push({x: snake.at(-1).x +snake_size, y: snake.at(-1).y})
            }
            else if(dir == 2) {
               
                snake.push({x: snake.at(-1).x, y: snake.at(-1).y+snake_size})
            }
            else if(dir == 3) {
                
                snake.push({x: snake.at(-1).x -snake_size, y: snake.at(-1).y})
            }
            else if(dir == 4) {
               
                snake.push({x: snake.at(-1).x, y: snake.at(-1).y-snake_size})
            }

        }
        function move_snake() {

            if(dir == 1 ) {
                snake.shift();

                if(snake.at(-1).x +snake_size > 1376) {
                    snake.push({x:0 , y: snake.at(-1).y})
                }
                else snake.push({x: snake.at(-1).x +snake_size, y: snake.at(-1).y})
            }
            else if(dir == 2 ) {
                snake.shift();
                if(snake.at(-1).y + snake_size > 768) {
                    snake.push({x: snake.at(-1).x, y: 0})
                }
                else snake.push({x: snake.at(-1).x, y: snake.at(-1).y+snake_size})
            }
            else if(dir == 3 ) {
                snake.shift();
                if(snake.at(-1).x - snake_size < 0 ) {
                    snake.push({x: 1376, y: snake.at(-1).y})
                }
                else snake.push({x: snake.at(-1).x -snake_size, y: snake.at(-1).y})
            }
            else if(dir == 4 ) {
                snake.shift();
                if(snake.at(-1).y - snake_size < 0 ) {
                    snake.push({x: snake.at(-1).x, y: 768})
                }
                else snake.push({x: snake.at(-1).x, y: snake.at(-1).y-snake_size})
            }

        }
        function keyPressed() {
           
            if (keyCode === LEFT_ARROW && dir != 1) {
               
                dir = 3;
            } else if (keyCode === RIGHT_ARROW && dir != 3) {
               
                dir = 1;
            }
            else if (keyCode === UP_ARROW && dir != 2) {
               
                dir = 4;
            }
            else if (keyCode === DOWN_ARROW && dir != 4) {
               
                dir = 2;
            }
        }
        function clearCanvas() {
            clear_Canvas = true;
        }

    </script>
     <div id="snakio">

     </div>
    <button id="clear_button" onclick="clearCanvas()"> PULISCI</button>
    <span id="coords"></span>
    


</body>

</html>